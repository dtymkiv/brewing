<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Probability Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            /*height: 100vh;*/
            background-color: #f4f4f4;
        }

        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }

        .container {
            width: 450px;
            padding: 5px;
            background-color: #fff;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 5px;
        }

        .grid-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
        }

        .element-name {
            font-weight: bold;
        }

        .input-group {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-group input {
            width: 20px;
            text-align: center;
        }

        .input-group button {
            margin: 0 5px;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }

        button:focus {
            outline: none;
        }

        .calculate-btn {
            margin-top: 20px;
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            text-align: center;
        }

        .calculate-btn:hover {
            background-color: #218838;
        }

        .history {
            margin-top: 20px;
        }

        .history ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .history li {
            background-color: #f8f9fa;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-size: 14px;
        }

        .history li:nth-child(odd) {
            background-color: #e9ecef;
        }

        .history h3 {
            margin-bottom: 10px;
        }

        .output {
            margin-top: 20px;
            font-size: 16px;
        }

        .output p {
            margin: 5px 0;
        }

        .element {
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #ccc;
            background-color: #f9f9f9;
        }

        /* Styling Fire elements */
        .element.fire {
            border-color: #e57373; /* Light Red border */
            background-color: #ffebee;
        }

        .element.fire label {
            color: #d32f2f; /* Darker red for text */
        }

        .element.fire input {
            color: #d32f2f;
            border: 1px solid #d32f2f;
        }

        /* Styling Water elements */
        .element.water {
            border-color: #64b5f6; /* Light Blue border */
            background-color: #e3f2fd;
        }

        .element.water label {
            color: #1976d2; /* Darker blue for text */
        }

        .element.water input {
            color: #1976d2;
            border: 1px solid #1976d2;
        }

        /* Styling Green elements */
        .element.green {
            border-color: #81c784; /* Light Green border */
            background-color: #e8f5e9;
        }

        .element.green label {
            color: #388e3c; /* Darker green for text */
        }

        .element.green input {
            color: #388e3c;
            border: 1px solid #388e3c;
        }

        /* Styling Stardust elements */
        .element.stardust {
            border-color: #ba68c8; /* Light Purple border */
            background-color: #f3e5f5;
        }

        .element.stardust label {
            color: #8e24aa; /* Darker purple for text */
        }

        .element.stardust input {
            color: #8e24aa;
            border: 1px solid #8e24aa;
        }

        /* Panel-like container */
        .simulation-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            margin-top: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            width: 100%;
            box-sizing: border-box;
        }

        /* Styling for the dropdown select */
        .simulation-panel select {
            margin-bottom: 15px;
            margin-right: 20px;
            padding: 8px;
            font-size: 1rem;
            border: 2px solid #007bff;
            border-radius: 5px;
            background-color: white;
            max-width: 200px;
            text-align: center;
            cursor: pointer;
        }

        /* Styling the simulate button */
        .simulation-panel .simulate-btn {
            max-width: 200px;
            padding: 10px;
            font-size: 1rem;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .simulation-panel .simulate-btn:hover {
            background-color: #218838;
        }

        /* Grid layout for dice results */
        .dice-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 items per row */
            gap: 15px;
            width: 100%;
            margin-top: 15px;
        }

        /* Dice container styling */
        .dice-container {
            position: relative; /* Set position to relative to position checkbox */
            display: flex;
            justify-content: center; /* Center the content inside */
            align-items: center; /* Center vertically */
            width: 60px;
            height: 60px; /* Keep height and width equal for square shape */
            border-radius: 8px; /* Rounded corners */
            margin-bottom: 10px;
            padding: 5px; /* Padding to add some space inside the container */
            background-color: #fff; /* Background color for dice */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* Light shadow for depth */
        }

        /* Grid layout for the contents inside the dice container */
        .dice-content {
            display: grid;
            grid-template-rows: 1fr auto; /* Two rows: one for label and one for roll number */
            justify-items: center; /* Center items in the grid */
        }

        /* Color coding for each dice type */
        .dice-container.fire {
            border: 2px solid #d32f2f;
            background-color: #ffebee;
        }

        .dice-container.water {
            border: 2px solid #1976d2;
            background-color: #e3f2fd;
        }

        .dice-container.green {
            border: 2px solid #388e3c;
            background-color: #e8f5e9;
        }

        .dice-container.stardust {
            border: 2px solid #8e24aa;
            background-color: #f3e5f5;
        }

        /* Label for the dice type (d6, d8, d12) */
        .dice-label {
            font-size: 0.9rem; /* Adjusted size for better fitting */
            font-weight: normal;
        }

        /* Roll number styling */
        .roll-number {
            font-size: 1.3rem;
            font-weight: bold;
        }

        /* Checkbox styling */
        .dice-checkbox {
            position: absolute; /* Position checkbox absolutely */
            bottom: -25px; /* Move it outside the square */
            transform: translateX(-50%) !important; /* Center it correctly */
            transform: scale(1.2) !important; /* Slightly larger checkbox for easier clicking */
        }

        /* Reroll button styling */
        .reroll-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 15px;
            width: 100%;
        }

        .reroll-btn:hover {
            background-color: #0056b3;
        }

        /* Winning message styling */
        #bombs-message {
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Brewing Calculator</h1>
    <div class="grid">
        <!-- Fire -->
        <div class="element fire">
            <div class="grid-item">
                <div class="element-name">Fire d6</div>
                <div class="input-group">
                    <button onclick="decrement('fire-d6')">-</button>
                    <input id="fire-d6" type="number" value="0" min="0">
                    <button onclick="increment('fire-d6')">+</button>
                </div>
            </div>
        </div>
        <div class="element fire">
            <div class="grid-item">
                <div class="element-name">Fire d8</div>
                <div class="input-group">
                    <button onclick="decrement('fire-d8')">-</button>
                    <input id="fire-d8" type="number" value="0" min="0">
                    <button onclick="increment('fire-d8')">+</button>
                </div>
            </div>
        </div>
        <div class="element fire">
            <div class="grid-item">
                <div class="element-name">Fire d12</div>
                <div class="input-group">
                    <button onclick="decrement('fire-d12')">-</button>
                    <input id="fire-d12" type="number" value="0" min="0">
                    <button onclick="increment('fire-d12')">+</button>
                </div>
            </div>
        </div>

        <!-- Water -->
        <div class="element water">
            <div class="grid-item">
                <div class="element-name">Water d6</div>
                <div class="input-group">
                    <button onclick="decrement('water-d6')">-</button>
                    <input id="water-d6" type="number" value="0" min="0">
                    <button onclick="increment('water-d6')">+</button>
                </div>
            </div>
        </div>
        <div class="element water">
            <div class="grid-item">
                <div class="element-name">Water d8</div>
                <div class="input-group">
                    <button onclick="decrement('water-d8')">-</button>
                    <input id="water-d8" type="number" value="0" min="0">
                    <button onclick="increment('water-d8')">+</button>
                </div>
            </div>
        </div>
        <div class="element water">
            <div class="grid-item">
                <div class="element-name">Water d12</div>
                <div class="input-group">
                    <button onclick="decrement('water-d12')">-</button>
                    <input id="water-d12" type="number" value="0" min="0">
                    <button onclick="increment('water-d12')">+</button>
                </div>
            </div>
        </div>

        <!-- Green -->
        <div class="element green">
            <div class="grid-item">
                <div class="element-name">Green d6</div>
                <div class="input-group">
                    <button onclick="decrement('green-d6')">-</button>
                    <input id="green-d6" type="number" value="0" min="0">
                    <button onclick="increment('green-d6')">+</button>
                </div>
            </div>
        </div>
        <div class="element green">
            <div class="grid-item">
                <div class="element-name">Green d8</div>
                <div class="input-group">
                    <button onclick="decrement('green-d8')">-</button>
                    <input id="green-d8" type="number" value="0" min="0">
                    <button onclick="increment('green-d8')">+</button>
                </div>
            </div>
        </div>
        <div class="element green">
            <div class="grid-item">
                <div class="element-name">Green d12</div>
                <div class="input-group">
                    <button onclick="decrement('green-d12')">-</button>
                    <input id="green-d12" type="number" value="0" min="0">
                    <button onclick="increment('green-d12')">+</button>
                </div>
            </div>
        </div>

        <!-- Stardust -->
        <div class="element stardust">
            <div class="grid-item">
                <div class="element-name">Stardust d6</div>
                <div class="input-group">
                    <button onclick="decrement('stardust-d6')">-</button>
                    <input id="stardust-d6" type="number" value="0" min="0">
                    <button onclick="increment('stardust-d6')">+</button>
                </div>
            </div>
        </div>
        <div class="element stardust">
            <div class="grid-item">
                <div class="element-name">Stardust d8</div>
                <div class="input-group">
                    <button onclick="decrement('stardust-d8')">-</button>
                    <input id="stardust-d8" type="number" value="0" min="0">
                    <button onclick="increment('stardust-d8')">+</button>
                </div>
            </div>
        </div>
        <div class="element stardust">
            <div class="grid-item">
                <div class="element-name">Stardust d12</div>
                <div class="input-group">
                    <button onclick="decrement('stardust-d12')">-</button>
                    <input id="stardust-d12" type="number" value="0" min="0">
                    <button onclick="increment('stardust-d12')">+</button>
                </div>
            </div>
        </div>
    </div>

    <button class="calculate-btn" onclick="calculate()">Calculate chances</button>
    <!-- Output placeholders -->
    <div class="output">
        <h3>Success chances</h3>
        <p id="result1">0 Bombs: --</p>
        <p id="result2">1 Bomb: --</p>
    </div>

    <div class="simulation-panel">
        <div class="sim-settings-holder">
            <!-- Dropdown to select probability to compare (0 bombs or 1 bomb) -->
            <label for="probability-select"></label>
            <select id="probability-select">
                <option value="0">0 Bombs Allowed</option>
                <option value="1">1 Bomb Allowed</option>
            </select>
            <!-- New button to simulate dice roll -->
            <button class="simulate-btn" onclick="simulateDiceRoll()">Simulate Dice Roll</button>
        </div>

        <!-- Output area for the dice roll results -->
        <div id="dice-roll-result" class="dice-grid">
            <!-- Dice rolls will be displayed here in a grid -->
        </div>
        <button class="reroll-btn" id="reroll-btn" onclick="rerollSelectedDice()" style="display: none;">Reroll Selected
            Dice
        </button>
        <p id="bombs-message"></p>
    </div>

    <!-- History of calculations -->
    <div class="history">
        <h3>Calculations history</h3>
        <ul id="history-list">
            <!-- List of previous calculations will appear here -->
        </ul>
    </div>
</div>

<script>
    function increment(id) {
        let input = document.getElementById(id);
        input.value = parseInt(input.value) + 1;
    }

    function decrement(id) {
        let input = document.getElementById(id);
        if (parseInt(input.value) > 0) {
            input.value = parseInt(input.value) - 1;
        }
    }

    // Probabilities for each ingredient and dice type
    const probabilities = {
        fireD6: 2 / 6,
        fireD8: 2 / 8,
        fireD12: 2 / 12,
        waterD6: 1 / 6,
        waterD8: 1 / 8,
        waterD12: 1 / 12,
        greenD6: 1 / 6,
        greenD8: 1 / 8,
        greenD12: 1 / 12,
        stardustD6: 3 / 6,
        stardustD8: 3 / 8,
        stardustD12: 3 / 12
    };

    // Function to calculate the success probability (binomial coefficient formula)
    function successProb(n, k, successProb) {
        const failureProb = 1 - successProb;

        // Binomial coefficient calculation
        function binomCoeff(n, k) {
            if (k === 0 || k === n) return 1;
            if (n === 0) return 0;
            let coeff = 1;
            for (let i = 1; i <= k; i++) {
                coeff *= (n - (k - i)) / i;
            }
            return coeff;
        }

        return binomCoeff(n, k) * (Math.pow(successProb, k)) * (Math.pow(failureProb, n - k));
    }

    // Function to calculate probabilities of rolling none or one success
    function noneOrOne(data) {
        // Calculate P(0) - the probability of no successes
        let p_0 = Object.keys(data).reduce((product, key) => {
            return product * successProb(data[key], 0, probabilities[key]);
        }, 1);

        // Calculate P(1) - the probability of exactly one success
        let p_1 = 0;
        Object.keys(data).forEach((key, i) => {
            p_1 += Object.keys(data).reduce((product, innerKey, j) => {
                return product * successProb(data[innerKey], (i === j ? 1 : 0), probabilities[innerKey]);
            }, 1);
        });

        // Return both probabilities
        return [p_0, p_0 + p_1];
    }

    let history = [];

    function clearDiceRoll() {

        document.getElementById("dice-roll-result").innerHTML = ''; // Clear previous dice rolls
        document.getElementById("reroll-btn").style.display = "none"; // hide reroll button
        document.getElementById("bombs-message").innerHTML = ''; // clear message

    }

    function calculate() {

        clearDiceRoll()

        let values = {
            fireD6: Number(document.getElementById("fire-d6").value),
            fireD8: Number(document.getElementById("fire-d8").value),
            fireD12: Number(document.getElementById("fire-d12").value),
            waterD6: Number(document.getElementById("water-d6").value),
            waterD8: Number(document.getElementById("water-d8").value),
            waterD12: Number(document.getElementById("water-d12").value),
            greenD6: Number(document.getElementById("green-d6").value),
            greenD8: Number(document.getElementById("green-d8").value),
            greenD12: Number(document.getElementById("green-d12").value),
            stardustD6: Number(document.getElementById("stardust-d6").value),
            stardustD8: Number(document.getElementById("stardust-d8").value),
            stardustD12: Number(document.getElementById("stardust-d12").value)
        };

        // Placeholder for actual calculation logic
        let calcResults = noneOrOne(values)

        // Convert results to percentages
        result1 = (calcResults[0] * 100).toFixed(2);
        result2 = (calcResults[1] * 100).toFixed(2);

        // Update results on the page with color grading
        document.getElementById("result1").innerHTML = `0 Bombs: <span style="color:${getColor(result1)};">${result1}%</span>`;
        document.getElementById("result2").innerHTML = `1 Bomb: <span style="color:${getColor(result2)};">${result2}%</span>`;

        // Save the inputs and results to the history
        let results = {
            result1: result1,
            result2: result2
        }
        let calculation = {...results, ...values};

        // Add to history (keep only the last 10)
        history.unshift(calculation);
        if (history.length > 6) {
            history.pop();
        }

        // Display the history
        let historyList = document.getElementById("history-list");
        historyList.innerHTML = '';  // Clear previous entries
        history.forEach((entry, index) => {
            let listItem = document.createElement("li");
            let diceText = '';

            // Add only non-zero dice counts to the text
            if (entry.fireD6 > 0) diceText += `Fire d6: ${entry.fireD6}, `;
            if (entry.fireD8 > 0) diceText += `Fire d8: ${entry.fireD8}, `;
            if (entry.fireD12 > 0) diceText += `Fire d12: ${entry.fireD12}, `;
            if (entry.waterD6 > 0) diceText += `Water d6: ${entry.waterD6}, `;
            if (entry.waterD8 > 0) diceText += `Water d8: ${entry.waterD8}, `;
            if (entry.waterD12 > 0) diceText += `Water d12: ${entry.waterD12}, `;
            if (entry.greenD6 > 0) diceText += `Green d6: ${entry.greenD6}, `;
            if (entry.greenD8 > 0) diceText += `Green d8: ${entry.greenD8}, `;
            if (entry.greenD12 > 0) diceText += `Green d12: ${entry.greenD12}, `;
            if (entry.stardustD6 > 0) diceText += `Stardust d6: ${entry.stardustD6}, `;
            if (entry.stardustD8 > 0) diceText += `Stardust d8: ${entry.stardustD8}, `;
            if (entry.stardustD12 > 0) diceText += `Stardust d12: ${entry.stardustD12}, `;

            // Remove the trailing comma and space
            diceText = diceText.slice(0, -2);

            // Add the results
            resText = `0 Bombs: <span style="color:${getColor(entry.result1)};">${entry.result1}%</span>, 1 Bomb: <span style="color:${getColor(entry.result2)};">${entry.result2}%</span> | `;
            resText += diceText
            listItem.innerHTML = `#${index + 1}: ${resText}`;
            historyList.appendChild(listItem);
        });
    }

    // Roll a single die (returns a random number based on the number of sides)
    function rollDie(sides) {
        return Math.floor(Math.random() * sides) + 1;
    }

    // Check if a roll is a failure based on the die type and the rolled number
    function isFail(dieType, roll) {
        const failNumbers = {
            fire: [1, 2],
            water: [1],
            green: [1],
            stardust: [1, 2, 3]
        };
        return failNumbers[dieType].includes(roll);
    }

    // Function to simulate rolling multiple dice and display the results
    function simulateDiceRoll() {
        // Check if there are any entries in history
        if (history.length === 0) {
            alert("No previous calculations available.");
            return;
        }

        // Get the most recent entry from history
        const lastEntry = history[0];

        // Extract values from the last entry
        const diceCounts = {
            fireD6: Number(lastEntry.fireD6),
            fireD8: Number(lastEntry.fireD8),
            fireD12: Number(lastEntry.fireD12),
            waterD6: Number(lastEntry.waterD6),
            waterD8: Number(lastEntry.waterD8),
            waterD12: Number(lastEntry.waterD12),
            greenD6: Number(lastEntry.greenD6),
            greenD8: Number(lastEntry.greenD8),
            greenD12: Number(lastEntry.greenD12),
            stardustD6: Number(lastEntry.stardustD6),
            stardustD8: Number(lastEntry.stardustD8),
            stardustD12: Number(lastEntry.stardustD12)
        };

        // Clear previous results
        const resultContainer = document.getElementById("dice-roll-result");
        resultContainer.innerHTML = '';

        // Dice configuration based on last entry
        const dice = [
            {type: "fire", sides: 6, count: diceCounts.fireD6},
            {type: "fire", sides: 8, count: diceCounts.fireD8},
            {type: "fire", sides: 12, count: diceCounts.fireD12},
            {type: "water", sides: 6, count: diceCounts.waterD6},
            {type: "water", sides: 8, count: diceCounts.waterD8},
            {type: "water", sides: 12, count: diceCounts.waterD12},
            {type: "green", sides: 6, count: diceCounts.greenD6},
            {type: "green", sides: 8, count: diceCounts.greenD8},
            {type: "green", sides: 12, count: diceCounts.greenD12},
            {type: "stardust", sides: 6, count: diceCounts.stardustD6},
            {type: "stardust", sides: 8, count: diceCounts.stardustD8},
            {type: "stardust", sides: 12, count: diceCounts.stardustD12}
        ];

        let bombCount = 0; // Count of bombs rolled

        // Roll each die and display the result
        dice.forEach(die => {
            // Roll the dice according to its count
            for (let i = 0; i < die.count; i++) {
                const roll = rollDie(die.sides); // Roll the die
                const isFailedRoll = isFail(die.type, roll); // Check if it's a fail

                // Increment bomb count if roll is a fail
                if (isFailedRoll) bombCount++;

                // Create the dice result element
                const diceElement = document.createElement("div");
                diceElement.classList.add("dice-result");

                // Set up the colored container and roll result
                diceElement.innerHTML = `
                    <div class="dice-container ${die.type}">
                        <div class="dice-content">
                            <span class="dice-label">${die.sides}</span>
                            <span class="roll-number" style="color: ${isFailedRoll ? 'red' : 'green'};">
                                ${roll}
                            </span>
                        </div>
                        <input type="checkbox" class="dice-checkbox" />
                    </div>
                `;

                // Append the dice result to the container
                resultContainer.appendChild(diceElement);
            }
        });

        // Display the bomb count message
        const allowedBombs = document.getElementById("probability-select").value;
        updateBombsMessage(bombCount, allowedBombs);

        // Show the reroll button after rolling the dice
        document.getElementById("reroll-btn").style.display = "block"; // Show reroll button

    }

    // Function to update winning message based on bomb count
    function updateBombsMessage(bombCount, allowedBombs) {
        const bombsMessage = document.getElementById("bombs-message");
        bombsMessage.style.color = bombCount <= allowedBombs ? 'green' : 'red';
        bombsMessage.textContent = `Total Bombs Rolled: ${bombCount}. ` +
            (bombCount <= allowedBombs ? "You won!" : "You lost!");
    }

    // Function to reroll selected dice
    function rerollSelectedDice() {
        const selectedDice = document.querySelectorAll('.dice-checkbox:checked');
        let bombCount = 0; // Reset bomb count for reroll

        selectedDice.forEach((checkbox) => {
            // Get the parent dice container of the checkbox
            const diceContainer = checkbox.closest('.dice-container');
            const rollLabel = diceContainer.querySelector('.roll-number');
            const sidesLabel = diceContainer.querySelector('.dice-label').textContent;
            const type = diceContainer.classList[1]; // Get the type (fire, water, etc.)

            // Roll the die again
            const roll = rollDie(sidesLabel); // sidesLabel is the sides number (d6, d8, d12)
            const isFailedRoll = isFail(type, roll); // Check if it's a fail

            // Update the roll number display
            rollLabel.textContent = roll;
            rollLabel.style.color = isFailedRoll ? 'red' : 'green';

            // Increment bomb count if rerolled value is a fail
            if (isFailedRoll) bombCount++;
        });

        // Update the winning message based on the new bomb count
        const allowedBombs = document.getElementById("probability-select").value;
        updateBombsMessage(bombCount, allowedBombs);
    }

    // Function to return color based on the percentage (red for low, green for high)
    function getColor(value) {
        value = parseFloat(value);
        if (value < 45) return '#ff4d4d';    // Red for low probability (< 45%)
        else if (value < 80) return '#ffa500';  // Orange for medium probability (45% - 80%)
        else return '#4caf50';  // Green for high probability (>= 80%)
    }
</script>

</body>
</html>
